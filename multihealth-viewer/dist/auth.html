<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Microsoft Auth</title>
  <script src="https://res.cdn.office.net/teams-js/2.12.0/js/MicrosoftTeams.min.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.25.0/js/msal-browser.min.js"></script>
</head>
<body>
<script>
  microsoftTeams.app.initialize();

  const msalConfig = {
    auth: {
      clientId: "1135fab5-62e8-4cb1-b472-880c477a8812",     // ✅ ton app id
      authority: "https://login.microsoftonline.com/03d0481a-a8ca-44b5-aeec-9bb332d93868",
      redirectUri: window.location.origin + "/auth.html"     // ✅ cette page
    }
  };

  const loginRequest = {
    scopes: [
      "openid",
      "profile",
      "User.Read",
      "offline_access",
      "Files.Read.All",
      "Sites.Read.All"
    ]
  };

  const msalInstance = new msal.PublicClientApplication(msalConfig);

  // ✅ Obligatoire dans Teams: détecter retour MSAL après le popup
  msalInstance.handleRedirectPromise()
    .then((response) => {
      if (response) {
        console.log("✅ Auth OK:", response);

        microsoftTeams.authentication.notifySuccess(response.accessToken);
      }
    })
    .catch((error) => {
      console.error("❌ Redirect error:", error);
      microsoftTeams.authentication.notifyFailure(error.toString());
    });

  // ✅ Login popup quand Teams ouvre auth.html
  msalInstance.loginPopup(loginRequest)
    .then((result) => {
      console.log("✅ Popup login success:", result);
      microsoftTeams.authentication.notifySuccess(result.accessToken);
    })
    .catch((err) => {
      console.error("❌ Popup login error:", err);
      microsoftTeams.authentication.notifyFailure(err.toString());
    });

</script>
</body>
</html>
